!function(){let e=document.getElementById("yousuli-calc-root");e&&(e.innerHTML=`
    <div class="wrapper__calc">
      <header class="header__calc">
        <h1 class="heading__primary--calc">Bike Power Speed Calculator</h1>
      </header>

      <!-- Route selector -->
      <div class="route__selector">
        <label for="routeSearch">Search race:</label>
        <input
          id="routeSearch"
          type="text"
          placeholder="Type part of race name..."
        />
        <label for="routeSelect">Route:</label>
        <select id="routeSelect">
          <option value="">— No route selected —</option>
        </select>
        <button id="resetRouteBtn" type="button">Reset</button>
        <div class="route__meta" id="routeMeta">
          No route selected. You can still enter distance, climb, and altitude
          manually.
        </div>
      </div>

      <!-- Calculation mode -->
      <div class="calcMode__wrapper">
        <div class="calcMode__box">
          <div class="row__calc">
            <label class="label__calc">Calculation mode</label>
            <div class="combined__calc">
              <select
                id="calcMode"
                class="input__calc"
                onchange="updateCalcModeUI(); calculateResult();"
              >
                <option value="power_to_time" selected>
                  Given average power → estimate finish time
                </option>
                <option value="time_to_power">
                  Given finish time → estimate average power
                </option>
                <option value="strategy_power">
                  Power strategy (advanced) → estimate finish time
                </option>
              </select>
            </div>
          </div>
          <div class="calcMode__inputs">
            <div class="row__calc" id="row_target_power">
              <label class="label__calc">Target average power</label>
              <div class="combined__calc">
                <input
                  type="number"
                  id="target_power"
                  class="input__calc"
                  value="220"
                  onchange="calculateResult()"
                />
                <span class="unit__calc">W</span>
              </div>
            </div>
            <div class="row__calc" id="row_finish_time">
              <label class="label__calc">Finish time</label>
              <div class="combined__calc--time">
                <input
                  type="number"
                  id="hh"
                  class="input__calc"
                  value="00"
                  placeholder="HH"
                  onchange="calculateResult()"
                />
                <span class="unit__calc--colon">:</span>
                <input
                  type="number"
                  id="mm"
                  class="input__calc"
                  value="37"
                  placeholder="MM"
                  onchange="calculateResult()"
                />
                <span class="unit__calc--colon">:</span>
                <input
                  type="number"
                  id="ss"
                  class="input__calc"
                  value="00"
                  placeholder="SS"
                  onchange="calculateResult()"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced power strategy -->
      <div id="advancedWrapper" class="advanced__wrapper" style="display: none">
        <div class="advanced__header">
          <div class="label__calc">Power strategy (advanced mode)</div>
          <div class="advanced__note">
            Uses the loaded course profile to estimate segment-by-segment pacing
            with different powers for short / medium / long climbs and a max
            descending speed.
          </div>
        </div>
        <div id="advancedFields" class="advanced__fields">
          <div class="row__calc">
            <label class="label__calc">FTP / CP</label>
            <div class="combined__calc">
              <input
                type="number"
                id="advanced_ftp"
                class="input__calc"
                value="320"
                onchange="syncFtpFromAdvanced(); calculateResult();"
              />
              <span class="unit__calc">W</span>
            </div>
          </div>
          <div class="row__calc">
            <label class="label__calc">Flat power</label>
            <div class="combined__calc">
              <input
                type="number"
                id="flat_power"
                class="input__calc"
                value="240"
                onchange="calculateResult();"
              />
              <span class="unit__calc">W</span>
            </div>
          </div>
          <div class="row__calc">
            <label class="label__calc">Climb &lt; 1 min power</label>
            <div class="combined__calc">
              <input
                type="number"
                id="climb1_power"
                class="input__calc"
                value="280"
                onchange="calculateResult();"
              />
              <span class="unit__calc">W</span>
            </div>
          </div>
          <div class="row__calc">
            <label class="label__calc">Climb &lt; 3 min power</label>
            <div class="combined__calc">
              <input
                type="number"
                id="climb3_power"
                class="input__calc"
                value="270"
                onchange="calculateResult();"
              />
              <span class="unit__calc">W</span>
            </div>
          </div>
          <div class="row__calc">
            <label class="label__calc">Climb &lt; 10 min power</label>
            <div class="combined__calc">
              <input
                type="number"
                id="climb10_power"
                class="input__calc"
                value="260"
                onchange="calculateResult();"
              />
              <span class="unit__calc">W</span>
            </div>
          </div>
          <div class="row__calc">
            <label class="label__calc">Max descending speed</label>
            <div class="combined__calc">
              <input
                type="number"
                id="max_descent_speed"
                class="input__calc"
                value="85"
                onchange="calculateResult();"
              />
              <span class="unit__calc" id="max_descent_unit">km/h</span>
            </div>
            <div class="notes">
              Caps speed on descents in the advanced pacing table.
            </div>
          </div>
        </div>
      </div>

      <div class="col__calc">
        <!-- Column 1 -->
        <div class="input__box--calc">
          <div class="row__calc">
            <label class="label__calc">Unit choice</label>
            <div class="combined__calc">
              <select id="unit" class="input__calc" onchange="changeUnit()">
                <option value="metric" selected>Metric</option>
                <option value="imperial">Imperial</option>
              </select>
            </div>
          </div>

          <div class="row__calc metric__row">
            <label class="label__calc">Rider weight</label>
            <div class="combined__calc">
              <input
                type="number"
                id="rider-weight-kg"
                class="input__calc"
                value="40"
                onchange="convertWeight(this,'lb','rider-weight');calculateResult()"
              />
              <span class="unit__calc">kg</span>
            </div>
          </div>
          <div class="row__calc imperial__row">
            <label class="label__calc">Rider weight</label>
            <div class="combined__calc">
              <input
                type="number"
                id="rider-weight-lb"
                class="input__calc"
                value="88.18"
                onchange="convertWeight(this,'kg','rider-weight');calculateResult()"
              />
              <span class="unit__calc">lb</span>
            </div>
          </div>

          <div class="row__calc metric__row">
            <label class="label__calc">Clothes & gear</label>
            <div class="combined__calc">
              <input
                type="number"
                id="clothes-gear-kg"
                class="input__calc"
                value="1.5"
                onchange="convertWeight(this,'lb','clothes-gear');calculateResult()"
              />
              <span class="unit__calc">kg</span>
            </div>
          </div>
          <div class="row__calc imperial__row">
            <label class="label__calc">Clothes & gear</label>
            <div class="combined__calc">
              <input
                type="number"
                id="clothes-gear-lb"
                class="input__calc"
                value="3.31"
                onchange="convertWeight(this,'kg','clothes-gear');calculateResult()"
              />
              <span class="unit__calc">lb</span>
            </div>
          </div>

          <div class="row__calc metric__row">
            <label class="label__calc">Bike weight</label>
            <div class="combined__calc">
              <input
                type="number"
                id="bike-weight-kg"
                class="input__calc"
                value="6.8"
                onchange="convertWeight(this,'lb','bike-weight');calculateResult()"
              />
              <span class="unit__calc">kg</span>
            </div>
          </div>
          <div class="row__calc imperial__row">
            <label class="label__calc">Bike weight</label>
            <div class="combined__calc">
              <input
                type="number"
                id="bike-weight-lb"
                class="input__calc"
                value="15.0"
                onchange="convertWeight(this,'kg','bike-weight');calculateResult()"
              />
              <span class="unit__calc">lb</span>
            </div>
          </div>

          <div class="row__calc">
            <label class="label__calc">Drive train efficiency (%)</label>
            <div class="combined__calc">
              <input
                type="number"
                id="driveTrainEfficiency"
                class="input__calc"
                value="98"
                min="80"
                max="100"
                onchange="calculateResult()"
              />
            </div>
          </div>
        </div>

        <!-- Column 2 -->
        <div class="input__box--calc">
          <div class="row__calc">
            <label class="label__calc">Tyre Condition (Crr)</label>
            <div class="combined__calc">
              <select
                id="tyreCondition"
                class="input__calc"
                onchange="changeTyreCondition()"
              >
                <option value="0.007">Off-road (0.007)</option>
                <option value="0.006">Poor / Budget (0.006)</option>
                <option value="0.0035" selected>Average (0.0035)</option>
                <option value="0.0030">Good perf (0.0030)</option>
                <option value="0.0023">Premium (0.0023)</option>
                <option value="0.0018">Velodrome (0.0018)</option>
              </select>
            </div>
          </div>
          <div class="row__calc">
            <label class="label__calc">Crr override</label>
            <div class="combined__calc">
              <input
                type="number"
                id="crr_rolling"
                class="input__calc"
                value="0.0035"
                step="0.0001"
                onchange="calculateResult()"
              />
            </div>
          </div>

          <div class="row__calc metric__row">
            <label class="label__calc">Distance</label>
            <div class="combined__calc">
              <input
                type="number"
                id="distance-km"
                class="input__calc"
                value="13.1"
                onchange="convertDistance(this,'mi','distance');calculateResult()"
              />
              <span class="unit__calc">km</span>
            </div>
          </div>
          <div class="row__calc imperial__row">
            <label class="label__calc">Distance</label>
            <div class="combined__calc">
              <input
                type="number"
                id="distance-mi"
                class="input__calc"
                value="8.14"
                onchange="convertDistance(this,'km','distance');calculateResult()"
              />
              <span class="unit__calc">mi</span>
            </div>
          </div>

          <div class="row__calc metric__row">
            <label class="label__calc">Total climb</label>
            <div class="combined__calc">
              <input
                type="number"
                id="total-climb-m"
                class="input__calc"
                value="1118"
                onchange="convertLength(this,'ft','total-climb');calculateResult()"
              />
              <span class="unit__calc">m</span>
            </div>
          </div>
          <div class="row__calc imperial__row">
            <label class="label__calc">Total climb</label>
            <div class="combined__calc">
              <input
                type="number"
                id="total-climb-ft"
                class="input__calc"
                value="3668.4"
                onchange="convertLength(this,'m','total-climb');calculateResult()"
              />
              <span class="unit__calc">ft</span>
            </div>
          </div>

          <div class="row__calc metric__row">
            <label class="label__calc">Temperature</label>
            <div class="combined__calc">
              <input
                type="number"
                id="temperature-c"
                class="input__calc"
                value="20"
                onchange="convertTemperature(this,'f','temperature');calculateResult()"
              />
              <span class="unit__calc">\xb0C</span>
            </div>
          </div>
          <div class="row__calc imperial__row">
            <label class="label__calc">Temperature</label>
            <div class="combined__calc">
              <input
                type="number"
                id="temperature-f"
                class="input__calc"
                value="68"
                onchange="convertTemperature(this,'c','temperature');calculateResult()"
              />
              <span class="unit__calc">\xb0F</span>
            </div>
          </div>

          <div class="row__calc">
            <label class="label__calc">Relative Humidity</label>
            <div class="combined__calc">
              <input
                type="number"
                id="relHumidity"
                class="input__calc"
                value="0"
                min="0"
                max="100"
                step="1"
                onchange="calculateResult()"
              />
              <span class="unit__calc">%</span>
            </div>
          </div>

          <div class="row__calc">
            <label class="label__calc">Altitude</label>
            <div class="combined__calc">
              <input
                type="number"
                id="altitude"
                class="input__calc"
                value="100"
                onchange="calculateResult()"
              />
              <span class="unit__calc">m</span>
            </div>
          </div>

          <div class="row__calc">
            <label class="label__calc">Air pressure override (optional)</label>
            <div class="combined__calc">
              <input
                type="number"
                id="pressure-hpa"
                class="input__calc"
                placeholder="e.g. 1013.25"
              />
              <span class="unit__calc">hPa</span>
            </div>
            <div class="notes">
              Leave blank to use standard atmosphere at the given altitude.
            </div>
          </div>

          <div class="row__calc">
            <label class="label__calc">Wind (\xb1 km/h or mi/h)</label>
            <div class="combined__calc metric__row">
              <input
                type="number"
                id="wind-metric"
                class="input__calc"
                value="0"
                min="-50"
                max="50"
                onchange="calculateResult()"
              />
              <span class="unit__calc">km/h</span>
            </div>
            <div class="combined__calc imperial__row">
              <input
                type="number"
                id="wind-imperial"
                class="input__calc"
                value="0"
                min="-31"
                max="31"
                onchange="calculateResult()"
              />
              <span class="unit__calc">mi/h</span>
            </div>
            <div class="notes">
              Positive = headwind. Negative = tailwind. Uses relative airspeed.
            </div>
          </div>
        </div>

        <!-- Column 3 -->
        <div class="input__box--calc">
          <div class="row__calc">
            <label class="label__calc">Position</label>
            <div class="combined__calc">
              <select
                id="position"
                class="input__calc"
                onchange="changePosition()"
              >
                <option value="0.18" selected>Aerobars pro</option>
                <option value="0.20">Aerobars elite</option>
                <option value="0.25">Aerobars advanced</option>
                <option value="0.37">Aerobars novice</option>
                <option value="0.40">Drops</option>
                <option value="0.42">Hoods</option>
                <option value="0.45">Tops</option>
                <option value="0.50">Standing</option>
              </select>
            </div>
          </div>

          <div class="row__calc">
            <label class="label__calc">Cda override</label>
            <div class="combined__calc">
              <input
                type="number"
                id="cdaAeroDynamicResistance"
                class="input__calc"
                value="0.18"
                step="0.01"
                onchange="calculateResult()"
              />
            </div>
          </div>

          <div class="row__calc">
            <label class="label__calc">Fitness</label>
            <div class="combined__calc">
              <input
                type="number"
                id="fitnessValue"
                class="input__calc"
                value="30"
                min="1"
                onchange="calculateResult()"
              />
            </div>
            <div class="notes">
              Used only for the rough “workout” label below.
            </div>
          </div>

          <div class="row__calc">
            <label class="label__calc">Known FTP/CP</label>
            <div class="combined__calc">
              <input
                type="number"
                id="known_ftp"
                class="input__calc"
                value="320"
                onchange="syncAdvancedFromFtp(); calculateResult()"
              />
              <span class="unit__calc">W</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Results & Course Analysis -->
      <div class="postcalc-wrapper">
        <div class="output__container--calc">
          <h3 class="heading__tertiary--calc">Results</h3>
          <div class="row__res--calc">
            <span class="res__label">Finish time (physics)</span>
            <span class="res__value" id="finishTimePhysics">—</span>
          </div>
          <div
            class="row__res--calc"
            id="finishTimeStrategyRow"
            style="display: none"
          >
            <span class="res__label">Finish time (strategy)</span>
            <span class="res__value" id="finishTimeStrategy">—</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Intensity Factor</span>
            <span class="res__value" id="intensity">0.00 IF</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Stress Score (avg-power proxy)</span>
            <span class="res__value" id="stressScore">0.00</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Workout</span>
            <span class="res__value" id="workoutDesc">Easy workout</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Avg W (physics est. / input)</span>
            <span class="res__value" id="avg_w">0.00 W</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Avg W/kg (body mass)</span>
            <span class="res__value" id="avg_w_kg">0.00 W/kg</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Speed</span>
            <span class="res__value" id="speed">0.00 km/h</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Slope Grade</span>
            <span class="res__value" id="slopeGrade">0.0000 %</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Air density used</span>
            <span class="res__value" id="rhoUsed">— kg/m\xb3</span>
          </div>
          <div class="row__res--calc">
            <span class="res__label">Pressure used</span>
            <span class="res__value" id="pressureUsed">— hPa</span>
          </div>
        </div>

        <div class="notes">
          <strong>Notes:</strong> Air density is computed from standard
          atmosphere (altitude) plus temperature and relative humidity (Tetens
          saturation vapor pressure → partial pressures). Rolling resistance
          uses the normal force on a grade (\xd7 cos θ). Headwind positive, tailwind
          negative; drag depends on relative airspeed.
        </div>

        <button id="toggleCourseAnalysis" class="courseToggleBtn">
          Show course analysis
        </button>

        <div id="courseAnalysis" class="courseAnalysis courseAnalysis--hidden">
          <!-- Map + Elevation -->
          <div class="route__visuals">
            <div id="map"></div>
            <div id="chart-wrapper">
              <canvas id="elevChart"></canvas>
              <div class="meta-bottom">
                When you choose a race above, the bike course will be drawn here
                with its elevation profile. You can override any
                distance/climb/altitude fields manually afterwards.
              </div>
            </div>
          </div>

          <section class="advancedPacing__section">
            <h3 class="heading__tertiary--calc">Advanced pacing (beta)</h3>
            <div id="advancedPacing" class="advanced-pacing-placeholder">
              Advanced pacing will appear here when you select “Power strategy
              (advanced)” and a route.
            </div>
          </section>

          <section class="techChallenges__section">
            <h3>Technical challenges</h3>
            <div id="techChallenges">
              <p style="margin: 0; font-size: 13px; color: #92400e">
                Select a route above to list climbs ≥ 3%, descents ≤ −3%, and
                sharp turns (&gt; 80\xb0).
              </p>
            </div>
            <div class="techNote">
              Thresholds: segments are grouped by continuous grade ≥ 3% (climbs)
              or ≤ −3% (descents). Sharp turns are heading changes &gt; 80\xb0.
            </div>
          </section>
        </div>
      </div>
    </div>
  `)}();const ROUTE_INDEX={Alpe_d_Huez:{name:"Alpe d Huez",file:"routes/Alpe_d_Huez.json",tempC:17,humidity:40},challenge_almere_amsterdam:{name:"Challenge Almere-Amsterdam",file:"routes/Challenge_Almere_Amsterdam.json",tempC:23,humidity:70},challenge_israman:{name:"Challenge Israman",file:"routes/Challenge_Israman.json",tempC:20,humidity:30},challenge_roth:{name:"Challenge Roth",file:"routes/Challenge_Roth.json",tempC:21,humidity:60},challenge703_israman:{name:"Challenge70.3 Israman",file:"routes/Challenge70.3_Israman.json",tempC:18,humidity:30},challenge703_oman:{name:"Challenge70.3 Oman",file:"routes/Challenge70.3_Oman.json",tempC:20,humidity:50},challenge703_rio:{name:"Challenge70.3 Rio de Janeiro",file:"routes/Challenge70.3_Rio_de_Janeiro.json",tempC:19,humidity:80},challenge703_sir_bani_yas:{name:"Challenge70.3 Sir Bani Yas",file:"routes/Challenge70.3_Sir_Bani_Yas.json",tempC:24,humidity:50},challenge703_wanaka_half:{name:"Challenge70.3 Wanaka Half",file:"routes/Challenge70.3_Wanaka_Half.json",tempC:20,humidity:50},challenge703_Xiamen:{name:"Challenge70.3 Xiamen",file:"routes/Challenge70.3_Xiamen.json",tempC:25,humidity:80},im703_alcudia_mallorca:{name:"IM703 Alcudia Mallorca",file:"routes/IM70.3_Alcudia_Mallorca.json",tempC:18,humidity:60},im703_aracaju_sergipe:{name:"IM703 Aracaju Sergipe",file:"routes/IM70.3_Aracaju_Sergipe.json",tempC:27,humidity:80},im703_bahrain:{name:"IM703 Bahrain",file:"routes/IM70.3_Bahrain.json",tempC:26,humidity:30},im703_cascais:{name:"IM703 Cascais",file:"routes/IM70.3_Cascais.json",tempC:19,humidity:70},im703_chattanooga:{name:"IM703 Chattanooga",file:"routes/IM70.3_Chattanooga.json",tempC:23,humidity:70},im703_coeur_d_alene:{name:"IM703 Coeur d'Alene",file:"routes/IM70.3_Coeur_d_Alene.json",tempC:20,humidity:50},im703_cozumel:{name:"IM703 Cozumel",file:"routes/IM70.3_Cozumel.json",tempC:28,humidity:85},im703_da_nang:{name:"IM703 Danang",file:"routes/IM70.3_Danang.json",tempC:30,humidity:85},im703_desaru_coast:{name:"IM703 Desaru Coast",file:"routes/IM70.3_Desaru_Coast.json",tempC:27,humidity:85},im703_elsinore:{name:"IM703 Elsinore",file:"routes/IM70.3_Elsinore.json",tempC:19,humidity:60},im703_emilia_romagna:{name:"IM703 Emilia Romagna",file:"routes/IM70.3_Emilia_Romagna.json",tempC:24,humidity:60},im703_florida:{name:"IM703 Florida",file:"routes/IM70.3_Florida.json",tempC:20,humidity:80},im703_geelong:{name:"IM703 Geelong",file:"routes/IM70.3_Geelong.json",tempC:19,humidity:50},im703_goseong:{name:"IM703 Goseong",file:"routes/IM70.3_Goseong.json",tempC:22,humidity:70},im703_gulf_coast:{name:"IM703 Gulf Coast",file:"routes/IM70.3_Gulf_Coast.json",tempC:24,humidity:80},im703_hawaii:{name:"IM703 Hawaii",file:"routes/IM70.3_Hawaii.json",tempC:26,humidity:70},im703_hengqin:{name:"IM703 Hengqin",file:"routes/IM70.3_Hengqin.json",tempC:20,humidity:70},im703_kenting:{name:"IM703 Kenting",file:"routes/IM70.3_Kenting.json",tempC:27,humidity:85},im703_knokke_heist:{name:"IM703 Knokke-Heist",file:"routes/IM70.3_Knokke_Heist.json",tempC:16,humidity:80},im703_kraichgau:{name:"IM703 Kraichgau",file:"routes/IM70.3_Kraichgau.json",tempC:18,humidity:60},im703_la_quinta:{name:"IM703 La Quinta",file:"routes/IM70.3_La_Quinta.json",tempC:14,humidity:30},im703_langkawi:{name:"IM703 Langkawi",file:"routes/IM70.3_Langkawi.json",tempC:29,humidity:90},im703_maine:{name:"IM703 Maine",file:"routes/IM70.3_Maine.json",tempC:23,humidity:70},im703_marathon_greece:{name:"IM703 Marathon Greece",file:"routes/IM70.3_Marathon_Greece.json",tempC:22,humidity:50},im703_michigan:{name:"IM703 Michigan",file:"routes/IM70.3_Michigan.json",tempC:22,humidity:60},im703_musselman:{name:"IM703 Musselman",file:"routes/IM70.3_Musselman.json",tempC:22,humidity:70},im703_new_york:{name:"IM703 New York",file:"routes/IM70.3_New_York.json",tempC:18,humidity:70},im703_new_zealand:{name:"IM703 New Zealand",file:"routes/IM70.3_New_Zealand.json",tempC:16,humidity:50},im703_nice:{name:"IM703 Nice",file:"routes/IM70.3_Nice.json",tempC:21,humidity:60},im703_north_carolina:{name:"IM703 North Carolina",file:"routes/IM70.3_North_Carolina.json",tempC:14,humidity:70},im703_northern_california:{name:"IM703 Northern California",file:"routes/IM70.3_Northern_California.json",tempC:26,humidity:30},im703_oceanside:{name:"IM703 Oceanside",file:"routes/IM70.3_OceanSide.json",tempC:14,humidity:80},im703_ohio:{name:"IM703 Ohio",file:"routes/IM70.3_Ohio.json",tempC:25,humidity:70},im703_panama:{name:"IM703 Panama",file:"routes/IM70.3_Panama.json",tempC:27,humidity:85},im703_peru:{name:"IM703 Peru",file:"routes/IM70.3_Peru.json",tempC:23,humidity:80},im703_pennsylvania_happy_valley:{name:"IM703 Pennsylvania Happy Valley",file:"routes/IM70.3_Pennsylvania_Happy_Valley.json",tempC:22,humidity:60},im703_phu_quoc:{name:"IM703 Phu Quoc",file:"routes/IM70.3_Phu_Quoc.json",tempC:28,humidity:85},im703_porec:{name:"IM703 Porec",file:"routes/IM70.3_Porec.json",tempC:22,humidity:60},im703_port_macquarie:{name:"IM703 Port Macquarie",file:"routes/IM70.3_Port_Macquarie.json",tempC:17,humidity:70},im703_puerto_rico:{name:"IM703 Puerto Rico",file:"routes/IM70.3_Puerto_Rico.json",tempC:26,humidity:85},im703_punta_del_este:{name:"IM703 Punta del Este",file:"routes/IM70.3_Punta_del_Este.json",tempC:23,humidity:60},im703_salem_oregon:{name:"IM703 Salem Oregon",file:"routes/IM70.3_Salem_Oregon.json",tempC:24,humidity:40},im703_sables_d_olonne:{name:"IM703 Les Sables d’Olonne",file:"routes/IM70.3_Sables_d_Olonne.json",tempC:18,humidity:70},im703_santa_cruz:{name:"IM703 Santa Cruz",file:"routes/IM70.3_Santa_Cruz.json",tempC:20,humidity:80},im703_shanghai:{name:"IM703 Shanghai",file:"routes/IM70.3_Shanghai.json",tempC:20,humidity:70},im703_sunshine_coast:{name:"IM703 Sunshine Coast",file:"routes/IM70.3_Sunshine_Coast.json",tempC:18,humidity:60},im703_swansea:{name:"IM703 Swansea",file:"routes/IM70.3_Swansea.json",tempC:18,humidity:80},im703_switzerland:{name:"IM703 Switzerland",file:"routes/IM70.3_Switzerland.json",tempC:18,humidity:60},im703_tallinn:{name:"IM703 Tallinn",file:"routes/IM70.3_Tallinn.json",tempC:15,humidity:70},im703_texas_galveston:{name:"IM703 Texas Galveston",file:"routes/IM70.3_Texas_Galveston.json",tempC:21,humidity:80},im703_valencia:{name:"IM703 Valencia",file:"routes/IM70.3_Valencia.json",tempC:16,humidity:50},im703_victoria_canada:{name:"IM703 Victoria Canada",file:"routes/IM70.3_Victoria_Canada.json",tempC:9,humidity:90},im703_vichy:{name:"IM703 Vichy",file:"routes/IM70.3_Vichy.json",tempC:22,humidity:60},im703_waco:{name:"IM703 Waco",file:"routes/IM70.3_Waco.json",tempC:24,humidity:80},im703_washington_tricities:{name:"IM703 Washington Tri-Cities",file:"routes/IM70.3_Washington_Tricities.json",tempC:16,humidity:30},im703_western_massachusetts:{name:"IM703 Western Massachusetts",file:"routes/IM70.3_Western_Massachusetts.json",tempC:19,humidity:70},im703_western_sydney:{name:"IM703 Western Sydney",file:"routes/IM70.3_Western_Sydney.json",tempC:16,humidity:50},im703_zell_am_see_kaprun:{name:"IM703 Zell am See-Kaprun",file:"routes/IM70.3_Zell_am_see_Kaprun.json",tempC:20,humidity:50},im_arizona:{name:"IM Arizona",file:"routes/IM_Arizona.json",tempC:16,humidity:20},im_australia:{name:"IM Australia",file:"routes/IM_Australia.json",tempC:17,humidity:70},im_austria:{name:"IM Austria Klagenfurt",file:"routes/IM_Austria_Klagenfurt.json",tempC:23,humidity:60},im_barcelona:{name:"IM Barcelona",file:"routes/IM_Barcelona.json",tempC:20,humidity:60},im_brazil:{name:"IM Brazil",file:"routes/IM_Brazil.json",tempC:18,humidity:60},im_cairns:{name:"IM Cairns",file:"routes/IM_Cairns.json",tempC:21,humidity:80},im_california:{name:"IM California",file:"routes/IM_California.json",tempC:18,humidity:40},im_cascais:{name:"IM Cascais",file:"routes/IM_Cascais.json",tempC:20,humidity:70},im_chattanooga_full:{name:"IM Chattanooga",file:"routes/IM_Chattanooga.json",tempC:26,humidity:80},im_copenhagen:{name:"IM Copenhagen",file:"routes/IM_Copenhagen.json",tempC:21,humidity:60},im_cozumel:{name:"IM Cozumel",file:"routes/IM_Cozumel.json",tempC:24,humidity:85},im_danang:{name:"IM Danang",file:"routes/IM_Danang.json",tempC:30,humidity:85},im_emilia_romagna:{name:"IM Italy Emilia-Romagna",file:"routes/IM_Emilia_Romagna.json",tempC:23,humidity:60},im_florida:{name:"IM Florida",file:"routes/IM_Florida.json",tempC:19,humidity:70},im_frankfurt:{name:"IM Frankfurt",file:"routes/IM_Frankfurt.json",tempC:23,humidity:60},im_hamburg:{name:"IM Hamburg 2025",file:"routes/IM_Hamburg.json",tempC:17,humidity:80},im_gurye_korea:{name:"IM Gurye Korea",file:"routes/IM_Gurye_Korea.json",tempC:24,humidity:80},im_japan_south_hokkaido:{name:"IM Japan South Hokkaido",file:"routes/IM_Japan_South_Hokkaido.json",tempC:22,humidity:50},im_kalmar:{name:"IM Kalmar",file:"routes/IM_Kalmar.json",tempC:18,humidity:60},im_kona:{name:"IM World Championship Kona",file:"routes/IM_Kona.json",tempC:28,humidity:70},im_lake_placid:{name:"IM Lake Placid",file:"routes/IM_Lake_Placid.json",tempC:18,humidity:70},im_lanzarote:{name:"IM Lanzarote",file:"routes/IM_Lanzarote.json",tempC:22,humidity:40},im_malaysia_langkawi:{name:"IM Malaysia Langkawi",file:"routes/IM_Malaysia_Langkawi.json",tempC:30,humidity:90},im_maryland:{name:"IM Maryland",file:"routes/IM_Maryland.json",tempC:20,humidity:80},im_new_zealand:{name:"IM New Zealand",file:"routes/IM_New_Zealand.json",tempC:14,humidity:60},im_nice:{name:"IM Nice",file:"routes/IM_Nice.json",tempC:26,humidity:60},im_ottawa:{name:"IM Ottawa",file:"routes/IM_Ottawa.json",tempC:22,humidity:70},im_penghu:{name:"IM Penghu",file:"routes/IM_Penghu.json",tempC:27,humidity:85},im_philippines:{name:"IM Philippines",file:"routes/IM_Philippines.json",tempC:28,humidity:85},im_sables_d_olonne:{name:"IM Les Sables d’Olonne",file:"routes/IM_Sables_d_Olonne.json",tempC:16,humidity:70},im_san_juan:{name:"IM San Juan",file:"routes/IM_San_juan.json",tempC:13,humidity:60},im_south_africa:{name:"IM South Africa",file:"routes/IM_South_Africa.json",tempC:19,humidity:50},im_switzerland_thun:{name:"IM Switzerland Thun",file:"routes/IM_Switzerland_Thun.json",tempC:22,humidity:50},im_tallinn:{name:"IM Tallinn",file:"routes/IM_Tallinn.json",tempC:16,humidity:60},im_texas:{name:"IM Texas",file:"routes/IM_Texas.json",tempC:27,humidity:80},im_valdivia:{name:"IM Valdivia",file:"routes/IM_Valdivia.json",tempC:14,humidity:80},im_vittoria_gasteiz:{name:"IM Vittoria-Gasteiz",file:"routes/IM_Vittoria_Gasteiz.json",tempC:18,humidity:50},im_wales:{name:"IM Wales",file:"routes/IM_Wales.json",tempC:14,humidity:85},im_western_australia:{name:"IM Western Australia",file:"routes/IM_Western_Australia.json",tempC:19,humidity:40},im_wisconsin:{name:"IM Wisconsin",file:"routes/IM_Wisconsin.json",tempC:18,humidity:70},stc_dishuihu:{name:"STC Dishuihu",file:"routes/STC70.3_Dishuihu.json",tempC:17,humidity:70},stc_qiandaohu:{name:"STC Qiandaohu",file:"routes/STC70.3_Qiandaohu.json",tempC:22,humidity:70},t100_french_riviera:{name:"T100 French Riviera",file:"routes/T100_French_Riviera.json",tempC:26,humidity:60},t100_french_singapore:{name:"T100 Singapore",file:"routes/T100_Singapore.json",tempC:30,humidity:90},taiwan_king_of_the_mountain:{name:"Taiwan KOM",file:"routes/Taiwan_King_of_the_Mountain.json",tempC:7,humidity:40},Ventoux:{name:"Ventoux",file:"routes/Ventoux.json",tempC:20,humidity:40},Xtri_Norseman:{name:"Xtri Norseman",file:"routes/Xtri_Norseman.json",tempC:18,humidity:85},Xtri_Pantagoniaman:{name:"Xtri Pantagoniaman",file:"routes/Xtri_Pantagoniaman.json",tempC:15,humidity:80}};function changeTyreCondition(){document.getElementById("crr_rolling").value=document.getElementById("tyreCondition").value,calculateResult()}function changePosition(){document.getElementById("cdaAeroDynamicResistance").value=document.getElementById("position").value,calculateResult()}function changeUnit(){let e=document.getElementById("unit").value;document.querySelectorAll(".metric__row").forEach(t=>t.style.display="metric"===e?"flex":"none"),document.querySelectorAll(".imperial__row").forEach(t=>t.style.display="imperial"===e?"flex":"none");let t=document.getElementById("max_descent_unit");t&&(t.textContent="metric"===e?"km/h":"mi/h"),calculateResult(),"function"==typeof updateChartUnits&&updateChartUnits(e),"function"==typeof rebuildTechnicalChallenges&&rebuildTechnicalChallenges()}function convertWeight(e,t,a){let l=parseFloat(e.value)||0,i=document.getElementById(a+"-"+t);i&&(i.value="kg"===t?(l/2.20462).toFixed(2):(2.20462*l).toFixed(2))}function convertDistance(e,t,a){let l=parseFloat(e.value)||0,i=document.getElementById(a+"-"+t);i&&(i.value="km"===t?(1.60934*l).toFixed(2):(l/1.60934).toFixed(2))}function convertLength(e,t,a){let l=parseFloat(e.value)||0,i=document.getElementById(a+"-"+t);i&&(i.value="m"===t?(l/3.28084).toFixed(2):(3.28084*l).toFixed(2))}function convertTemperature(e,t,a){let l=parseFloat(e.value)||0,i=document.getElementById(a+"-"+t);i&&(i.value="c"===t?((l-32)*5/9).toFixed(2):(9*l/5+32).toFixed(2))}function pressureAtAltitude(e,t){return t&&t>0?100*t:101325*Math.pow(1-.0065*e/288.15,.28404373326/.054044007017)}function saturationVaporPressure_Pa(e){return 610.78*Math.exp(17.27*e/(e+237.3))}function moistAirDensity(e,t,a){let l=t+273.15,i=saturationVaporPressure_Pa(t),n=Math.max(0,Math.min(.99*e,i))*(Math.max(0,Math.min(100,a))/100);return Math.max(1,e-n)/(287.05*l)+n/(461.495*l)}function formatTimeFromHours(e){let t=Math.max(0,3600*e),a=Math.floor(t/3600),l=Math.floor((t-3600*a)/60),i=Math.round(t-3600*a-60*l);return 60===i&&(i=0,l+=1),60===l&&(l=0,a+=1),String(a).padStart(2,"0")+":"+String(l).padStart(2,"0")+":"+String(i).padStart(2,"0")}function updateCalcModeUI(){let e=document.getElementById("calcMode").value,t=document.getElementById("row_target_power"),a=document.getElementById("row_finish_time"),l=document.getElementById("advancedWrapper"),i=document.getElementById("finishTimeStrategyRow");"power_to_time"===e?(t&&(t.style.display="flex"),a&&(a.style.display="flex"),l&&(l.style.display="none"),i&&(i.style.display="none")):"time_to_power"===e?(t&&(t.style.display="none"),a&&(a.style.display="flex"),l&&(l.style.display="none"),i&&(i.style.display="none")):"strategy_power"===e&&(t&&(t.style.display="none"),a&&(a.style.display="none"),l&&(l.style.display="block"),i&&(i.style.display="flex"))}function syncFtpFromAdvanced(){let e=parseFloat(document.getElementById("advanced_ftp").value||"0")||0,t=document.getElementById("known_ftp");t&&e>0&&(t.value=e)}function syncAdvancedFromFtp(){let e=parseFloat(document.getElementById("known_ftp").value||"0")||0,t=document.getElementById("advanced_ftp");t&&e>0&&(t.value=e)}function segmentPowerForSpeed(e,t,a,l,i,n,s,o){let c=Math.abs(e+s);return Math.max(0,.5*n*i*c*c*e+9.80665*a*l*(1/Math.sqrt(1+t*t))*e+9.80665*a*(t/Math.sqrt(1+t*t))*e)/Math.max(.01,o)}function solveSpeedForTargetPower(e,t,a,l,i,n,s,o){if(e<=0)return 0;let c=.5,r=25;for(let d=0;d<32;d++){let m=.5*(c+r),u=segmentPowerForSpeed(m,t,a,l,i,n,s,o);u>e?r=m:c=m}return c}function rebuildAdvancedPacing(){let e=document.getElementById("advancedPacing"),t=document.getElementById("calcMode").value,a=document.getElementById("finishTimeStrategyRow"),l=document.getElementById("finishTimeStrategy");if(!e)return;if("strategy_power"!==t){e.innerHTML='<p style="margin:0;font-size:14px;color:#555;">Select “Power strategy (advanced)” to see per-segment pacing.</p>',a&&(a.style.display="none"),l&&(l.textContent="—");return}let i=window.currentRouteSmooth||window.currentRouteProfile;if(!i||!i.distances||i.distances.length<2){e.innerHTML='<p style="margin:0;font-size:14px;color:#555;">Advanced pacing needs a selected course with elevation data.</p>',a&&(a.style.display="flex"),l&&(l.textContent="—");return}let n=i.distances,s=i.elevations,o=n[n.length-1],c=document.getElementById("unit").value,r="metric"===c?parseFloat(document.getElementById("wind-metric").value||"0"):parseFloat(document.getElementById("wind-imperial").value||"0");r="metric"===c?r/3.6:.44704*r;let d=parseFloat(document.getElementById("temperature-c").value||"0")||0,m=parseFloat(document.getElementById("altitude").value||"0")||0,u=parseFloat(document.getElementById("relHumidity").value||"0")||0,$=parseFloat(document.getElementById("pressure-hpa").value||"0")||0,p=pressureAtAltitude(m,$),h=moistAirDensity(p,d,u),v=parseFloat(document.getElementById("rider-weight-kg").value||"0")||0,g=parseFloat(document.getElementById("clothes-gear-kg").value||"0")||0,y=parseFloat(document.getElementById("bike-weight-kg").value||"0")||0,f=v+g+y,b=parseFloat(document.getElementById("cdaAeroDynamicResistance").value||"0.18")||.18,I=parseFloat(document.getElementById("crr_rolling").value||"0.0035")||.0035,C=(parseFloat(document.getElementById("driveTrainEfficiency").value||"98")||98)/100;parseFloat(document.getElementById("advanced_ftp").value||document.getElementById("known_ftp").value||"0");let _=parseFloat(document.getElementById("flat_power").value||"0")||0,M=parseFloat(document.getElementById("climb1_power").value||"0")||0,w=parseFloat(document.getElementById("climb3_power").value||"0")||0,E=parseFloat(document.getElementById("climb10_power").value||"0")||0;if(_<=0){e.innerHTML='<p style="margin:0;font-size:14px;color:#555;">Set at least a flat power in the advanced box above.</p>',a&&(a.style.display="flex"),l&&(l.textContent="—");return}let x=parseFloat(document.getElementById("max_descent_speed").value||"0")||0,k=1/0;x>0&&(k="metric"===c?x/3.6:.44704*x);let B=o>=120?5:3,j=[],S=0,R=n[0];for(let T=1;T<n.length;T++){let F=n[T]-R,A=n[T]-n[T-1],P=1e3*A,z=s[T]-s[T-1],W=P>0?z/P:0,D=Math.abs(W)>=.08&&A>=.7,H=F>=B&&T>S+1;D?(T-1>S&&j.push({start:S,end:T-1}),j.push({start:T-1,end:T}),S=T,R=n[T]):H&&(j.push({start:S,end:T}),S=T,R=n[T])}S<n.length-1&&j.push({start:S,end:n.length-1});let N=0,O=[];for(let K=0;K<j.length;K++){let U=j[K],V=n[U.start],G=n[U.end],q=Math.max(.001,G-V),X=1e3*q,Y=s[U.start],Z=s[U.end],Q=X>0?(Z-Y)/X:0,J="Flat/rolling";Q>=.01?J="Climb":Q<=-.01&&(J="Descent");let ee=_;if("Climb"===J){let et=E>0?E:_,ea=solveSpeedForTargetPower(et,Q,f,I,b,h,r,C);ea<=0&&(ea=5);let el=X/ea;ee=el<=60&&M>0?M:el<=180&&w>0?w:E>0?E:_}let ei=solveSpeedForTargetPower(ee,Q,f,I,b,h,r,C);if("Descent"===J&&ei>k&&(ei=k),ei<=0)continue;let en=X/ei;N+=en;let es=3.6*ei,eo="metric"===c?es:es/1.60934,ec="metric"===c?q:q/1.60934,er="metric"===c?V:V/1.60934,ed="metric"===c?G:G/1.60934,em=100*Q;function eu(e){let t=Math.floor(e/3600),a=Math.floor((e-3600*t)/60),l=Math.round(e-3600*t-60*a),i=[];return t>0&&i.push(String(t).padStart(2,"0")),i.push(String(a).padStart(2,"0")),i.push(String(l).padStart(2,"0")),i.join(":")}O.push({from:er,to:ed,len:ec,kind:J,grade:em,power:ee,speed:eo,time:en,timeStr:eu(en)})}if(!O.length){e.innerHTML='<p style="margin:0;font-size:14px;color:#555;">Route profile too short to build pacing segments.</p>',a&&(a.style.display="flex"),l&&(l.textContent="—");return}let e8="metric"===c?"km":"mi",e$='<table class="advTable"><thead><tr><th>#</th><th>From ('+e8+")</th><th>To ("+e8+")</th><th>Len ("+e8+")</th><th>Type</th><th>Grade (%)</th><th>Power (W)</th><th>Speed ("+("metric"===c?"km/h":"mi/h")+")</th><th>Time</th></tr></thead><tbody>";function ep(e){let t=Math.floor(e/3600),a=Math.floor((e-3600*t)/60);return String(t).padStart(2,"0")+":"+String(a).padStart(2,"0")+":"+String(Math.round(e-3600*t-60*a)).padStart(2,"0")}O.forEach((e,t)=>{e$+="<tr><td>"+(t+1)+"</td><td>"+e.from.toFixed(1)+"</td><td>"+e.to.toFixed(1)+"</td><td>"+e.len.toFixed(1)+"</td><td>"+e.kind+"</td><td>"+e.grade.toFixed(1)+"</td><td>"+e.power.toFixed(0)+"</td><td>"+e.speed.toFixed(1)+"</td><td>"+e.timeStr+"</td></tr>"}),e$+="</tbody></table>",e$+='<p class="advSummaryLine">Advanced pacing total time (sum of segments): <strong>'+ep(N)+"</strong></p>",e.innerHTML=e$,a&&(a.style.display="flex"),l&&(l.textContent=ep(N))}function bearingDeg(e,t,a,l){var i;let n=e=>e*Math.PI/180,s=n(e),o=n(a),c=n(l-t),r=Math.sin(c)*Math.cos(o),d=Math.cos(s)*Math.sin(o)-Math.sin(s)*Math.cos(o)*Math.cos(c),m=Math.atan2(r,d);return((m=180*m/Math.PI)+360)%360}function rebuildTechnicalChallenges(){let e=document.getElementById("techChallenges");if(!e)return;let t=window.currentRouteSmooth||window.currentRouteProfile;if(!t||!t.distances||!t.elevations||!t.latlngs){e.innerHTML='<p style="margin:0;font-size:13px;color:#92400e;">Select a route above to list climbs ≥ 3%, descents ≤ −3%, and sharp turns (&gt; 80\xb0).</p>';return}let a=t.distances,l=t.elevations,i=t.latlngs,n=Math.min(a.length,l.length,i.length);if(n<3){e.innerHTML='<p style="margin:0;font-size:13px;color:#92400e;">Route profile is too short to extract technical challenges.</p>';return}let s=document.getElementById("unit").value,o="metric"===s?1:1/1.60934,c="metric"===s?"km":"mi",r=[],d=[],m=null,u=0;for(let $=1;$<n;$++){let p=a[$]-a[$-1],h=1e3*p;if(h<=0)continue;let v=l[$]-l[$-1],g=v/h,y=null;if(g>=.03?y="climb":g<=-.03&&(y="descent"),y!==m){if(m&&$-1>u){let f=u,b=$-1,I=a[f],C=a[b],_=Math.max(0,C-I);if(_>=.2){let M=l[b]-l[f],w=_>0?M/(1e3*_):0,E={startIdx:f,endIdx:b,startKm:I,endKm:C,lenKm:_,avgGrade:w};"climb"===m?r.push(E):"descent"===m&&d.push(E)}}y?(u=$-1,m=y):m=null}}if(m&&u<n-1){let x=u,k=n-1,B=a[x],j=a[k],S=Math.max(0,j-B);if(S>=.2){let R=l[k]-l[x],T={startIdx:x,endIdx:k,startKm:B,endKm:j,lenKm:S,avgGrade:S>0?R/(1e3*S):0};"climb"===m?r.push(T):"descent"===m&&d.push(T)}}let F=[];for(let A=1;A<n-1;A++){let[P,z]=i[A-1],[W,D]=i[A],[H,N]=i[A+1],O=bearingDeg(P,z,W,D),K=bearingDeg(W,D,H,N),U=Math.abs(K-O);U>180&&(U=360-U),U>80&&F.push({idx:A,km:a[A],angle:U})}let V=[];F.sort((e,t)=>e.km-t.km);let G=-1/0;for(let q of F)if(q.km-G>=.15)V.push({...q}),G=q.km;else if(V.length){let X=V[V.length-1];q.angle>X.angle&&(X.angle=q.angle)}if(!r.length&&!d.length&&!V.length){e.innerHTML='<p style="margin:0;font-size:13px;color:#92400e;">No climbs ≥ 3%, descents ≤ −3%, or turns &gt; 80\xb0 found on this route.</p>';return}let Y="";r.length&&(Y+="<h4>Climbs ≥ 3% grade</h4>",Y+='<table class="techTable"><thead><tr><th>#</th><th>From ('+c+")</th><th>To ("+c+")</th><th>Distance ("+c+")</th><th>Avg grade (%)</th></tr></thead><tbody>",r.forEach((e,t)=>{let a=e.startKm*o,l=e.endKm*o,i=e.lenKm*o,n=100*e.avgGrade;Y+="<tr><td>"+(t+1)+"</td><td>"+a.toFixed(2)+"</td><td>"+l.toFixed(2)+"</td><td>"+i.toFixed(2)+"</td><td>"+n.toFixed(1)+"</td></tr>"}),Y+="</tbody></table>"),d.length&&(Y+="<h4>Descents ≤ −3% grade</h4>",Y+='<table class="techTable"><thead><tr><th>#</th><th>From ('+c+")</th><th>To ("+c+")</th><th>Distance ("+c+")</th><th>Avg grade (%)</th></tr></thead><tbody>",d.forEach((e,t)=>{let a=e.startKm*o,l=e.endKm*o,i=e.lenKm*o,n=100*e.avgGrade;Y+="<tr><td>"+(t+1)+"</td><td>"+a.toFixed(2)+"</td><td>"+l.toFixed(2)+"</td><td>"+i.toFixed(2)+"</td><td>"+n.toFixed(1)+"</td></tr>"}),Y+="</tbody></table>"),V.length&&(Y+="<h4>Sharp turns (&gt; 80\xb0)</h4>",Y+='<table class="techTable"><thead><tr><th>#</th><th>At ('+c+")</th><th>Turn angle (\xb0)</th></tr></thead><tbody>",V.forEach((e,t)=>{let a=e.km*o;Y+="<tr><td>"+(t+1)+"</td><td>"+a.toFixed(2)+"</td><td>"+e.angle.toFixed(1)+"</td></tr>"}),Y+="</tbody></table>"),e.innerHTML=Y}function calculateResult(){let e=parseFloat(document.getElementById("rider-weight-kg").value||0)||0,t=parseFloat(document.getElementById("clothes-gear-kg").value||0)||0,a=parseFloat(document.getElementById("bike-weight-kg").value||0)||0,l=e+t+a,i=parseFloat(document.getElementById("distance-km").value||0)||0,n=parseFloat(document.getElementById("total-climb-m").value||0)||0,s=document.getElementById("unit").value,o="metric"===s?parseFloat(document.getElementById("wind-metric").value||0):parseFloat(document.getElementById("wind-imperial").value||0);o="metric"===s?o/3.6:.44704*o;let c=parseFloat(document.getElementById("temperature-c").value||0)||0,r=parseFloat(document.getElementById("altitude").value||0)||0,d=parseFloat(document.getElementById("relHumidity").value||0)||0,m=parseFloat(document.getElementById("pressure-hpa").value||0)||0,u=pressureAtAltitude(r,m),$=moistAirDensity(u,c,d),p=parseFloat(document.getElementById("cdaAeroDynamicResistance").value)||.18,h=parseFloat(document.getElementById("crr_rolling").value)||.0035,v=(parseFloat(document.getElementById("driveTrainEfficiency").value)||98)/100,g=i>0?n/(1e3*i):0,y=g/Math.sqrt(1+g*g),f=1/Math.sqrt(1+g*g);function b(e){let t=e+o,a=Math.abs(t);return Math.max(0,.5*$*p*a*a*e+9.80665*l*h*f*e+9.80665*l*y*e)/Math.max(.01,v)}let I=document.getElementById("calcMode").value,C=0,_=0,M=1/3600;if("power_to_time"===I){let w=parseFloat(document.getElementById("target_power").value||0)||0;if(w>0){let E=.1,x=30;for(let k=0;k<40;k++){let B=.5*(E+x),j=b(B);j>w?x=B:E=B}_=.5*(E+x);let S=3.6*_;M=i/Math.max(S,.1),C=w;let R=3600*M,T=Math.floor(R/3600),F=Math.floor((R-3600*T)/60),A=Math.round(R-3600*T-60*F);60===A&&(A=0,F+=1),60===F&&(F=0,T+=1);let P=document.getElementById("hh"),z=document.getElementById("mm"),W=document.getElementById("ss");P&&(P.value=String(T).padStart(2,"0")),z&&(z.value=String(F).padStart(2,"0")),W&&(W.value=String(A).padStart(2,"0"))}else{let D=parseFloat(document.getElementById("hh").value||0)||0,H=parseFloat(document.getElementById("mm").value||0)||0,N=parseFloat(document.getElementById("ss").value||0)||0;M=D+H/60+N/3600||1/3600;let O=i/M;C=b(_=1e3*O/3600)}}else if("time_to_power"===I){let K=parseFloat(document.getElementById("hh").value||0)||0,U=parseFloat(document.getElementById("mm").value||0)||0,V=parseFloat(document.getElementById("ss").value||0)||0;M=K+U/60+V/3600||1/3600;let G=i/M;C=b(_=1e3*G/3600)}else if("strategy_power"===I){let q=parseFloat(document.getElementById("flat_power").value||0)||0;if(q>0){let X=.1,Y=30;for(let Z=0;Z<40;Z++){let Q=.5*(X+Y),J=b(Q);J>q?Y=Q:X=Q}_=.5*(X+Y);let ee=3.6*_;M=i/Math.max(ee,.1),C=q}else{let et=parseFloat(document.getElementById("hh").value||0)||0,ea=parseFloat(document.getElementById("mm").value||0)||0,el=parseFloat(document.getElementById("ss").value||0)||0;M=et+ea/60+el/3600||1/3600;let ei=i/M;C=b(_=1e3*ei/3600)}}let en=3.6*_,es=e?C/e:0,eo=Math.max(1,parseFloat(document.getElementById("known_ftp").value||1)||1),ec=C/eo,er=M*ec*ec*100,ed="Easy workout",em=Math.max(1,parseFloat(document.getElementById("fitnessValue").value||1)||1),eu=er/em;eu>2.01?ed="Extreme workout":eu>1.5?ed="Hard workout":eu>1.25?ed="Moderately hard workout":eu>.75&&(ed="Average workout"),document.getElementById("intensity").textContent=ec.toFixed(2)+" IF",document.getElementById("stressScore").textContent=er.toFixed(2),document.getElementById("workoutDesc").textContent=ed,document.getElementById("avg_w").textContent=C.toFixed(1)+" W",document.getElementById("avg_w_kg").textContent=es.toFixed(2)+" W/kg",document.getElementById("speed").textContent=en.toFixed(2)+("metric"===s?" km/h":" mi/h"),document.getElementById("slopeGrade").textContent=(100*g).toFixed(4)+" %",document.getElementById("rhoUsed").textContent=$.toFixed(4)+" kg/m\xb3",document.getElementById("pressureUsed").textContent=(u/100).toFixed(1)+" hPa",document.getElementById("finishTimePhysics").textContent=formatTimeFromHours(M),rebuildAdvancedPacing()}console.log("ROUTE_INDEX keys:",Object.keys(ROUTE_INDEX).length);let map=null,polyline=null,elevChart=null;function updateChartUnits(e){if(!window.currentRouteProfile||!elevChart)return;let t="imperial"===e,a=window.currentRouteProfile.distances||[],l=window.currentRouteProfile.elevations||[],i=t?a.map(e=>e/1.60934):a.slice(),n=t?l.map(e=>3.28084*e):l.slice(),s,o;if("number"==typeof window.currentRouteProfile.elev_min&&"number"==typeof window.currentRouteProfile.elev_max)s=window.currentRouteProfile.elev_min-10,o=window.currentRouteProfile.elev_max+10;else if(l.length){let c=l[0],r=l[0];for(let d=1;d<l.length;d++)l[d]<c&&(c=l[d]),l[d]>r&&(r=l[d]);s=c-10,o=r+10}else s=0,o=1;let m=t?3.28084*s:s,u=t?3.28084*o:o;elevChart.data.labels=i,elevChart.data.datasets[0].data=n,elevChart.options.scales.x.title.text=t?"Distance (mi)":"Distance (km)",elevChart.options.scales.y.title.text=t?"Elevation (ft)":"Elevation (m)",elevChart.options.scales.y.min=m,elevChart.options.scales.y.max=u,elevChart.options.plugins.tooltip.callbacks.title=e=>{if(!e.length)return"";let a=e[0].label,l=("number"==typeof a?a:parseFloat(a))||0;return(t?"mi ":"km ")+l.toFixed(2)},elevChart.options.plugins.tooltip.callbacks.label=e=>{let a=e.parsed.y||0;return"Elevation: "+a.toFixed(0)+(t?" ft":" m")},elevChart.update()}!function e(){let t=document.getElementById("map");t&&window.L?(map=L.map("map").setView([0,0],2),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}).addTo(map)):console.warn("Leaflet (L) or #map not available, skipping map init");let a=document.getElementById("elevChart");if(a&&window.Chart){let l=a.getContext("2d");elevChart=new Chart(l,{type:"line",data:{labels:[],datasets:[{data:[],fill:!1,borderWidth:2,pointRadius:0,tension:.2},]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Distance (km)"},ticks:{maxTicksLimit:10,callback(e){let t="number"==typeof e?e:parseFloat(e);return isFinite(t)?t.toFixed(1):e}}},y:{title:{display:!0,text:"Elevation (m)"}}},plugins:{legend:{display:!1},tooltip:{mode:"index",intersect:!1,callbacks:{title(e){if(!e.length)return"";let t=e[0].label,a="number"==typeof t?t:parseFloat(t);return isFinite(a)?"km "+a.toFixed(2):""},label:e=>"Elevation: "+e.parsed.y+" m"}}}}})}else console.warn("Chart.js or #elevChart not available, skipping chart init"),elevChart={data:{labels:[],datasets:[{data:[]}]},options:{scales:{x:{title:{}},y:{title:{}}},plugins:{tooltip:{callbacks:{}}}},update(){}}}();let routeSelectEl,routeSearchEl,resetRouteBtn,routeMetaEl;function initRouteUI(){if(routeSelectEl=document.getElementById("routeSelect"),routeSearchEl=document.getElementById("routeSearch"),resetRouteBtn=document.getElementById("resetRouteBtn"),routeMetaEl=document.getElementById("routeMeta"),!routeSelectEl){console.warn("routeSelect element not found – skipping route UI init");return}rebuildRouteOptions(""),routeSearchEl&&routeSearchEl.addEventListener("input",function(e){rebuildRouteOptions(e.target.value)}),resetRouteBtn&&resetRouteBtn.addEventListener("click",function(){routeSearchEl&&(routeSearchEl.value=""),rebuildRouteOptions(""),clearRouteView(),localStorage.removeItem("bikesim_last_route")});let e=localStorage.getItem("bikesim_last_route");e&&ROUTE_INDEX[e]&&(routeSelectEl.value=e,loadRoute(e)),routeSelectEl.addEventListener("change",e=>{let t=e.target.value;t?loadRoute(t):(clearRouteView(),localStorage.removeItem("bikesim_last_route"))});let t=document.getElementById("toggleCourseAnalysis"),a=document.getElementById("courseAnalysis");t&&a&&t.addEventListener("click",()=>{let e=a.classList.toggle("courseAnalysis--hidden");if(t.textContent=e?"Show course analysis":"Hide course analysis",!e){let l=document.getElementById("unit").value||"metric";updateChartUnits(l),rebuildTechnicalChallenges(),rebuildAdvancedPacing(),map&&setTimeout(()=>{map.invalidateSize(),polyline&&map.fitBounds(polyline.getBounds(),{padding:[20,20]})},0)}})}function clearRouteView(){polyline&&map&&(map.removeLayer(polyline),polyline=null),map&&map.setView([0,0],2),elevChart&&(elevChart.data.labels=[],elevChart.data.datasets[0].data=[],elevChart.update()),routeMetaEl&&(routeMetaEl.textContent="No route selected. You can still enter distance, climb, and altitude manually."),window.currentRouteProfile=null,window.currentRouteSmooth=null,rebuildAdvancedPacing();let e=document.getElementById("techChallenges");e&&(e.innerHTML='<p style="margin:0;font-size:13px;color:#92400e;">Select a route above to list climbs ≥ 3%, descents ≤ −3%, and sharp turns (&gt; 80\xb0).</p>')}function haversineMeters(e,t,a,l){let i=Math.PI/180,n=(a-e)*i,s=(l-t)*i,o=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*i)*Math.cos(a*i)*Math.sin(s/2)*Math.sin(s/2);return 6371e3*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}function buildNormalizedRoute(e){let t=Object.assign({},e),a=Array.isArray(e.elevations)?e.elevations:[],l=Array.isArray(e.latlngs)?e.latlngs:[],{totalClimb:i,minE:n,maxE:s}=function e(t){if(!Array.isArray(t)||t.length<2)return{totalClimb:0,minE:0,maxE:0};let a=0,l=Number(t[0]),i=Number(t[0]);for(let n=1;n<t.length;n++){let s=Number(t[n-1]),o=Number(t[n]),c=o-s;c>0&&(a+=c),o<l&&(l=o),o>i&&(i=o)}return{totalClimb:a,minE:l,maxE:i}}(a),o=Math.min(l.length,a.length);if(o>=2){let c=[],r=[];for(let d=0;d<o;d++){let m=l[d],u=Number(m[0]),$=Number(m[1]);c.push([u,$]),r.push(Number(a[d]))}let p=[],h=0;p.push(0);for(let v=1;v<o;v++){let[g,y]=c[v-1],[f,b]=c[v],I=haversineMeters(g,y,f,b);h+=I/1e3,p.push(Number(h.toFixed(3)))}let C=p[p.length-1]||0,_="number"==typeof e.distance_km&&e.distance_km>.1?e.distance_km:C;return t.distances=p,t.elevations=r,t.latlngs=c,t.distance_km=_,t.total_climb_m="number"==typeof e.total_climb_m&&e.total_climb_m>0?e.total_climb_m:Math.round(i),t.elev_min="number"==typeof e.elev_min&&0!==e.elev_min?e.elev_min:n,t.elev_max="number"==typeof e.elev_max&&0!==e.elev_max?e.elev_max:s,t}t.elevations=a,t.latlngs=l,t.distances=Array.isArray(e.distances)?e.distances:[];let M=0;if(t.distances.length>1){let w=Number(t.distances[t.distances.length-1]);isFinite(w)&&w>0&&(M=w)}return t.distance_km="number"==typeof e.distance_km&&e.distance_km>0?e.distance_km:M,t.total_climb_m="number"==typeof e.total_climb_m&&e.total_climb_m>0?e.total_climb_m:Math.round(i),t.elev_min="number"==typeof e.elev_min&&0!==e.elev_min?e.elev_min:n,t.elev_max="number"==typeof e.elev_max&&0!==e.elev_max?e.elev_max:s,t}function buildSmoothedProfile(e){if(!e||!Array.isArray(e.distances)||!Array.isArray(e.elevations)||!Array.isArray(e.latlngs))return null;let t=e.distances,a=e.elevations,l=e.latlngs,i=Math.min(t.length,a.length,l.length);if(i<2)return null;let n=t[i-1];if(!isFinite(n)||n<=0)return null;let s=Math.max(.1,Math.min(.5,n/400)),o=[],c=[],r=[],d=0,m=0;for(;d<n-1e-6;){for(;m<i-2&&t[m+1]<d;)m++;let u=t[m],$=t[m+1],p=$>u?(d-u)/($-u):0,h=a[m],v=a[m+1],g=h+(v-h)*p,y=l[m][0],f=l[m][1],b=l[m+1][0],I=l[m+1][1],C=y+(b-y)*p,_=f+(I-f)*p;o.push(d),c.push(g),r.push([C,_]),d+=s}(0===o.length||o[o.length-1]<n-1e-6)&&(o.push(n),c.push(a[i-1]),r.push(l[i-1]));let M=c.slice();for(let w=0;w<c.length;w++){let E=0,x=0;for(let k=-2;k<=2;k++){let B=w+k;B>=0&&B<c.length&&(E+=c[B],x++)}x>0&&(M[w]=E/x)}return{distances:o,elevations:M,latlngs:r}}async function loadRoute(e){if(!e)return;let t=ROUTE_INDEX[e];if(t)try{let a=await fetch(t.file);if(!a.ok)throw Error("HTTP "+a.status);let l=await a.json(),i=buildNormalizedRoute(l);window.currentRouteProfile=i,window.currentRouteSmooth=buildSmoothedProfile(i),polyline&&(map.removeLayer(polyline),polyline=null),Array.isArray(i.latlngs)&&i.latlngs.length>1?(polyline=L.polyline(i.latlngs,{weight:4,color:"#ef4444"}).addTo(map),map.fitBounds(polyline.getBounds(),{padding:[20,20]})):map&&map.setView([0,0],2);let n=document.getElementById("unit").value||"metric";if(updateChartUnits(n),"number"==typeof i.distance_km&&i.distance_km>0){let s=i.distance_km,o=document.getElementById("distance-km"),c=document.getElementById("distance-mi");o&&(o.value=s.toFixed(1)),c&&(c.value=(s/1.60934).toFixed(2))}if("number"==typeof i.total_climb_m&&i.total_climb_m>0){let r=i.total_climb_m,d=document.getElementById("total-climb-m"),m=document.getElementById("total-climb-ft");d&&(d.value=r.toFixed(0)),m&&(m.value=(3.28084*r).toFixed(0))}if("number"==typeof t.tempC){let u=document.getElementById("temperature-c"),$=document.getElementById("temperature-f");u&&(u.value=t.tempC.toFixed(1)),$&&($.value=(9*t.tempC/5+32).toFixed(1))}if("number"==typeof t.humidity){let p=document.getElementById("relHumidity");p&&(p.value=t.humidity.toFixed(0))}if(Array.isArray(i.elevations)&&i.elevations.length>0){let h=i.elevations[0],v=document.getElementById("altitude");v&&(v.value=Math.round(h))}let g="number"==typeof i.distance_km&&i.distance_km>0?i.distance_km:Array.isArray(i.distances)&&i.distances.length?i.distances[i.distances.length-1]:0,y="number"==typeof i.total_climb_m?i.total_climb_m:0,f="number"==typeof i.elev_min?i.elev_min:Array.isArray(i.elevations)&&i.elevations.length?Math.min.apply(null,i.elevations):0,b="number"==typeof i.elev_max?i.elev_max:Array.isArray(i.elevations)&&i.elevations.length?Math.max.apply(null,i.elevations):0,I=i.name||t.name||e;routeMetaEl&&(routeMetaEl.textContent=`${I} – ${g.toFixed(1)} km, climb ≈ ${y.toFixed(0)} m (avg grade ≈ ${(g>0?y/(10*g):0).toFixed(1)}%), elevation ${f.toFixed(0)}–${b.toFixed(0)} m`),localStorage.setItem("bikesim_last_route",e),calculateResult(),rebuildTechnicalChallenges()}catch(C){console.error("Failed to load route",e,C),routeMetaEl&&(routeMetaEl.textContent="Error loading route data.");let _=document.getElementById("techChallenges");_&&(_.innerHTML='<p style="margin:0;font-size:13px;color:#92400e;">Error loading route data, cannot compute technical challenges.</p>')}}function rebuildRouteOptions(e){let t=(e||"").toLowerCase();if(!routeSelectEl)return;for(;routeSelectEl.options.length>0;)routeSelectEl.remove(0);let a=document.createElement("option");a.value="",a.textContent="— No route selected —",routeSelectEl.appendChild(a);let l=[];for(let i in ROUTE_INDEX)Object.prototype.hasOwnProperty.call(ROUTE_INDEX,i)&&l.push({key:i,meta:ROUTE_INDEX[i]});l.sort(function(e,t){let a=(e.meta.name||e.key).toLowerCase(),l=(t.meta.name||t.key).toLowerCase();return a<l?-1:a>l?1:0}),l.forEach(function(e){let a=e.key,l=e.meta,i=l.name||a,n=(i+" "+a).toLowerCase();if(!t||-1!==n.indexOf(t)){let s=document.createElement("option");s.value=a,s.textContent=i,routeSelectEl.appendChild(s)}}),e&&2===routeSelectEl.options.length?(routeSelectEl.selectedIndex=1,loadRoute(routeSelectEl.value)):routeSelectEl.value=""}window.addEventListener("load",initRouteUI);
